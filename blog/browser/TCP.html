<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>TCP/IP | 幸湘</title>
    <meta name="description" content="幸湘的博客">
    <link rel="icon" href="./public/image/favicon.ico">
    
    <link rel="preload" href="/assets/css/0.styles.5c2ae73b.css" as="style"><link rel="preload" href="/assets/js/app.ab7145cf.js" as="script"><link rel="preload" href="/assets/js/2.85147661.js" as="script"><link rel="preload" href="/assets/js/11.3d9cf837.js" as="script"><link rel="prefetch" href="/assets/js/10.5890ca08.js"><link rel="prefetch" href="/assets/js/12.3df023dd.js"><link rel="prefetch" href="/assets/js/13.550f62fd.js"><link rel="prefetch" href="/assets/js/14.e0728202.js"><link rel="prefetch" href="/assets/js/15.9b749930.js"><link rel="prefetch" href="/assets/js/16.feeba172.js"><link rel="prefetch" href="/assets/js/17.7591929d.js"><link rel="prefetch" href="/assets/js/18.f84af26d.js"><link rel="prefetch" href="/assets/js/19.f77ae857.js"><link rel="prefetch" href="/assets/js/3.04624b6a.js"><link rel="prefetch" href="/assets/js/4.beec2cf0.js"><link rel="prefetch" href="/assets/js/5.d485f776.js"><link rel="prefetch" href="/assets/js/6.725315dd.js"><link rel="prefetch" href="/assets/js/7.1b3180b0.js"><link rel="prefetch" href="/assets/js/8.c168fcd9.js"><link rel="prefetch" href="/assets/js/9.1470d827.js">
    <link rel="stylesheet" href="/assets/css/0.styles.5c2ae73b.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">幸湘</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">Home</a></div><div class="nav-item"><a href="/blog/" class="nav-link router-link-active">Blog</a></div><div class="nav-item"><a href="https://github.com/JessieHu27" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">Home</a></div><div class="nav-item"><a href="/blog/" class="nav-link router-link-active">Blog</a></div><div class="nav-item"><a href="https://github.com/JessieHu27" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>JavaScript基础</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/blog/js/JavaScript继承.html" class="sidebar-link">JavaScript继承</a></li><li><a href="/blog/js/JavaScript函数相关.html" class="sidebar-link">JavaScript函数相关</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>CSS基础</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/blog/css/CSS篇（一）.html" class="sidebar-link">CSS篇（一）</a></li><li><a href="/blog/css/CSS篇（二）.html" class="sidebar-link">CSS篇（二）</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>浏览器</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/blog/browser/缓存.html" class="sidebar-link">缓存</a></li><li><a href="/blog/browser/跨域.html" class="sidebar-link">跨域</a></li><li><a href="/blog/browser/HTTP.html" class="sidebar-link">HTTP</a></li><li><a href="/blog/browser/TCP.html" class="active sidebar-link">TCP</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog/browser/TCP.html#tcp连接的建立" class="sidebar-link">TCP连接的建立</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog/browser/TCP.html#第一次握手-syn-1-，seq-x" class="sidebar-link">第一次握手(SYN=1,，seq=x)</a></li><li class="sidebar-sub-header"><a href="/blog/browser/TCP.html#第二次握手-syn-1，ack-1，ack-x-1，seq-y" class="sidebar-link">第二次握手(SYN=1，ACK=1，ack=x+1，seq=y)</a></li><li class="sidebar-sub-header"><a href="/blog/browser/TCP.html#第三次握手-ack-1，ack-y-1，seq-z" class="sidebar-link">第三次握手(ACK=1，ack=y+1，seq=z)</a></li></ul></li><li class="sidebar-sub-header"><a href="/blog/browser/TCP.html#tcp连接的断开" class="sidebar-link">TCP连接的断开</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog/browser/TCP.html#第一次挥手-fin-1，seq-x" class="sidebar-link">第一次挥手(FIN=1，seq=x)</a></li><li class="sidebar-sub-header"><a href="/blog/browser/TCP.html#第二次挥手-ack-1，ack-x-1，seq-y" class="sidebar-link">第二次挥手(ACK=1，ack=x+1，seq=y)</a></li><li class="sidebar-sub-header"><a href="/blog/browser/TCP.html#第三次挥手-ack-1，fin-1，ack-x-1，seq-z" class="sidebar-link">第三次挥手(ACK=1，FIN=1，ack=x+1，seq=z)</a></li><li class="sidebar-sub-header"><a href="/blog/browser/TCP.html#第四次挥手-ack-1，ack-z-1-seq-x-1" class="sidebar-link">第四次挥手 (ACK=1，ack=z+1,seq=x+1)</a></li></ul></li></ul></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="tcp-ip"><a href="#tcp-ip" class="header-anchor">#</a> TCP/IP</h1> <div class="custom-block tip"><p class="custom-block-title">TIP</p> <p>TCP/IP协议模型（Transmission Control Protocol/Internet Protocol），包含了一系列构成互联网基础的网络协议，是Internet的核心协议。</p></div> <h2 id="tcp连接的建立"><a href="#tcp连接的建立" class="header-anchor">#</a> TCP连接的建立</h2> <p>TCP是面向连接的，无论哪一方向另一方发送数据之前，都必须先在双方之间建立一条连接。在TCP/IP协议中，TCP协议提供可靠的连接服务，连接是通过三次握手进行初始化的。三次握手的目的是同步连接双方的序列号和确认号并交换 TCP窗口大小信息。</p> <p><img src="https://xx93.club/static/blog/browser/%E4%B8%89%E6%AC%A1%E6%8F%A1%E6%89%8B.png" alt="三次握手"></p> <h3 id="第一次握手-syn-1-，seq-x"><a href="#第一次握手-syn-1-，seq-x" class="header-anchor">#</a> 第一次握手(<code>SYN=1,，seq=x</code>)</h3> <p>建立连接。客户端发送连接请求报文段，将SYN位置为1，Sequence Number为x；然后，客户端进入SYN_SEND状态，等待服务器的确认；</p> <div class="custom-block warning"><p class="custom-block-title">WARNING</p> <p>TCP规定，SYN报文段（SYN=1的报文段）不能携带数据，但需要消耗掉一个序号。</p></div> <h3 id="第二次握手-syn-1，ack-1，ack-x-1，seq-y"><a href="#第二次握手-syn-1，ack-1，ack-x-1，seq-y" class="header-anchor">#</a> 第二次握手(<code>SYN=1，ACK=1，ack=x+1，seq=y</code>)</h3> <p>服务器收到SYN报文段。服务器收到客户端的SYN报文段，需要对这个SYN报文段进行确认，设置Acknowledgment Number为x+1(Sequence Number+1)；同时，自己自己还要发送SYN请求信息，将SYN位置为1，Sequence Number为y；服务器端将上述所有信息放到一个报文段（即SYN+ACK报文段）中，一并发送给客户端，此时服务器进入SYN_RECV状态；</p> <div class="custom-block warning"><p class="custom-block-title">WARNING</p> <p>ACK报文段（ACK=1的报文段）可以携带数据， 但是如果不携带数据则不消耗序号</p></div> <h3 id="第三次握手-ack-1，ack-y-1，seq-z"><a href="#第三次握手-ack-1，ack-y-1，seq-z" class="header-anchor">#</a> 第三次握手(<code>ACK=1，ack=y+1，seq=z</code>)</h3> <p>客户端收到服务器的SYN+ACK报文段。然后将Acknowledgment Number设置为y+1，向服务器发送ACK报文段，这个报文段发送完毕以后，客户端和服务器端都进入ESTABLISHED状态，完成TCP三次握手。</p> <div class="custom-block tip"><p class="custom-block-title">为什么要三次握手？</p> <p>为了防止已失效的连接请求报文段突然又传送到了服务端，因而产生错误。</p> <p>具体例子：“已失效的连接请求报文段”的产生在这样一种情况下：client发出的第一个连接请求报文段并没有丢失，而是在某个网络结点长时间的滞留了，以致延误到连接释放以后的某个时间才到达server。本来这是一个早已失效的报文段。但server收到此失效的连接请求报文段后，就误认为是client再次发出的一个新的连接请求。于是就向client发出确认报文段，同意建立连接。假设不采用“三次握手”，那么只要server发出确认，新的连接就建立了。由于现在client并没有发出建立连接的请求，因此不会理睬server的确认，也不会向server发送数据。但server却以为新的运输连接已经建立，并一直等待client发来数据。这样，server的很多资源就白白浪费掉了。采用“三次握手”的办法可以防止上述现象发生。例如刚才那种情况，client不会向server的确认发出确认。server由于收不到确认，就知道client并没有要求建立连接。”</p></div> <h2 id="tcp连接的断开"><a href="#tcp连接的断开" class="header-anchor">#</a> TCP连接的断开</h2> <p>当客户端和服务器通过三次握手建立了TCP连接以后，当数据传送完毕，肯定是要断开TCP连接的啊。那对于TCP的断开连接，这里就有了神秘的“四次挥手”。</p> <p><img src="https://xx93.club/static/blog/browser/%E5%9B%9B%E6%AC%A1%E6%8C%A5%E6%89%8B.png" alt="四次挥手"></p> <h3 id="第一次挥手-fin-1，seq-x"><a href="#第一次挥手-fin-1，seq-x" class="header-anchor">#</a> 第一次挥手(<code>FIN=1，seq=x</code>)</h3> <p>主动方（可以是客户端，也可以是服务器），设置Sequence Number = x，向被动方发送一个FIN报文段；此时，主动方进入FIN_WAIT_1 （终止等待1） 状态；这表示主动方没有数据要发送给被动方了；</p> <div class="custom-block warning"><p class="custom-block-title">WARNING</p> <p>TCP规定，FIN报文段即使不携带数据，也要消耗一个序号。</p></div> <h3 id="第二次挥手-ack-1，ack-x-1，seq-y"><a href="#第二次挥手-ack-1，ack-x-1，seq-y" class="header-anchor">#</a> 第二次挥手(<code>ACK=1，ack=x+1，seq=y</code>)</h3> <p>被动方收到了主动方发送的FIN报文段，向主动方回一个ACK报文段，Acknowledgment Number为x + 1，设置Sequence Number = y；被动方进入CLOSE_WAIT （关闭等待） 状态，主动方接收到应答报文后进入FIN_WAIT_2（终止等待2）状态；被动方告诉主动方，我“同意”你的关闭请求；</p> <h3 id="第三次挥手-ack-1，fin-1，ack-x-1，seq-z"><a href="#第三次挥手-ack-1，fin-1，ack-x-1，seq-z" class="header-anchor">#</a> 第三次挥手(<code>ACK=1，FIN=1，ack=x+1，seq=z</code>)</h3> <p>被动方向主动方发送FIN + ACK报文段，请求关闭连接，同时被动方进入LAST_ACK（ 最后确认 ）状态；</p> <h3 id="第四次挥手-ack-1，ack-z-1-seq-x-1"><a href="#第四次挥手-ack-1，ack-z-1-seq-x-1" class="header-anchor">#</a> 第四次挥手 (<code>ACK=1，ack=z+1,seq=x+1</code>)</h3> <p>主动方收到被动方发送的FIN报文段，向被动方发送ACK报文段，然后主动方进入TIME_WAIT状态；被动方收到主动方的ACK报文段以后，进入CLOSED状态关闭连接；此时，主动方等待2*MSL（ 最长报文段寿命 ）后依然没有收到回复，则证明Server端已正常关闭，那好，主动方也可以关闭连接了。</p> <div class="custom-block tip"><p class="custom-block-title">主动方为什么要等待2*MSL</p> <p>MSL（Maximum Segment Lifetime），TCP允许不同的实现可以设置不同的MSL值。</p> <ul><li><p>保证客户端发送的最后一个ACK报文能够到达服务器，因为这个ACK报文可能丢失，站在服务器的角度看来，我已经发送了FIN+ACK报文请求断开了，客户端还没有给我回应，应该是我发送的请求断开报文它没有收到，于是服务器又会重新发送一次，而客户端就能在这个2MSL时间段内收到这个重传的报文，接着给出回应报文，并且会重启2MSL计时器。</p></li> <li><p>防止类似与“三次握手”中提到了的“已经失效的连接请求报文段”出现在本连接中。客户端发送完最后一个确认报文后，在这个2MSL时间中，就可以使本连接持续的时间内所产生的所有报文段都从网络中消失。这样新的连接中不会出现旧连接的请求报文。</p></li></ul></div> <div class="custom-block tip"><p class="custom-block-title">为什么建立连接是三次握手，关闭连接确是四次挥手呢？</p> <p>建立连接的时候， 服务器在LISTEN状态下，收到建立连接请求的SYN报文后，把ACK和SYN放在一个报文里发送给客户端。而关闭连接时，服务器收到对方的FIN报文时，仅仅表示对方不再发送数据了但是还能接收数据，而自己也未必全部数据都发送给对方了，所以己方可以立即关闭，也可以发送一些数据给对方后，再发送FIN报文给对方来表示同意现在关闭连接，因此，己方ACK和FIN一般都会分开发送，从而导致多了一次。</p></div> <p>参考：</p> <ul><li><a href="https://juejin.im/post/598ba1d06fb9a03c4d6464ab#heading-16" target="_blank" rel="noopener noreferrer">关于 TCP/IP<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li> <li><a href="https://blog.csdn.net/qzcsu/article/details/72861891" target="_blank" rel="noopener noreferrer">TCP连接建立与断开<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/blog/browser/HTTP.html" class="prev">HTTP</a></span> <!----></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.ab7145cf.js" defer></script><script src="/assets/js/2.85147661.js" defer></script><script src="/assets/js/11.3d9cf837.js" defer></script>
  </body>
</html>
